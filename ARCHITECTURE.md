# ğŸ—ï¸ Push Notifications Architecture

Visual guide to how the push notification system works.

---

## ğŸ“ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER'S BROWSER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   React App      â”‚         â”‚    Service Worker (SW)      â”‚ â”‚
â”‚  â”‚  (pages/index)   â”‚         â”‚    (public/sw.js)           â”‚ â”‚
â”‚  â”‚                  â”‚         â”‚                             â”‚ â”‚
â”‚  â”‚  â€¢ Subscribe UI  â”‚         â”‚  â€¢ Push event handler       â”‚ â”‚
â”‚  â”‚  â€¢ Test button   â”‚         â”‚  â€¢ Show notification        â”‚ â”‚
â”‚  â”‚  â€¢ Status        â”‚         â”‚  â€¢ Click handler            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                              â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚ HTTPS                        â”‚ Push Protocol
            â”‚                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      YOUR NEXT.JS SERVER                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              API Routes (pages/api/push/)              â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  GET  /vapid-public-key  â†’ Returns VAPID public key   â”‚   â”‚
â”‚  â”‚  POST /subscribe         â†’ Save subscription          â”‚   â”‚
â”‚  â”‚  POST /unsubscribe       â†’ Remove subscription        â”‚   â”‚
â”‚  â”‚  POST /send             â†’ Send notifications          â”‚   â”‚
â”‚  â”‚  GET  /list-subscriptions â†’ List all subscriptions    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                   â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Business Logic (lib/)                     â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  â€¢ mongodb.ts  â†’ Database connection                  â”‚   â”‚
â”‚  â”‚  â€¢ vapid.ts    â†’ VAPID configuration                  â”‚   â”‚
â”‚  â”‚  â€¢ web-push    â†’ Send push notifications              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                   â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ MongoDB Protocol
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MONGODB DATABASE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Collection: subscriptions                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  {                                                     â”‚   â”‚
â”‚  â”‚    _id: ObjectId,                                      â”‚   â”‚
â”‚  â”‚    endpoint: "https://fcm.googleapis.com/...",         â”‚   â”‚
â”‚  â”‚    keys: {                                             â”‚   â”‚
â”‚  â”‚      p256dh: "...",                                    â”‚   â”‚
â”‚  â”‚      auth: "..."                                       â”‚   â”‚
â”‚  â”‚    },                                                  â”‚   â”‚
â”‚  â”‚    userAgent: "Mozilla/5.0...",                        â”‚   â”‚
â”‚  â”‚    createdAt: ISODate("2026-01-13T..."),               â”‚   â”‚
â”‚  â”‚    updatedAt: ISODate("2026-01-13T...")                â”‚   â”‚
â”‚  â”‚  }                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Data Flow

### 1. Subscribe Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚
â”‚  clicks  â”‚
â”‚ "Enable" â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Request notification permission                  â”‚
â”‚    Notification.requestPermission()                 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Get VAPID public key                             â”‚
â”‚    GET /api/push/vapid-public-key                   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Subscribe to push manager                        â”‚
â”‚    pushManager.subscribe({                          â”‚
â”‚      applicationServerKey: vapidPublicKey           â”‚
â”‚    })                                               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Save subscription to database                    â”‚
â”‚    POST /api/push/subscribe                         â”‚
â”‚    {                                                â”‚
â”‚      endpoint: "https://...",                       â”‚
â”‚      keys: { p256dh: "...", auth: "..." }           â”‚
â”‚    }                                                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. MongoDB stores subscription                      â”‚
â”‚    db.subscriptions.insertOne(...)                  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User is â”‚
â”‚subscribedâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Send Notification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ External â”‚
â”‚  System  â”‚
â”‚ (or User)â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Send notification request                        â”‚
â”‚    POST /api/push/send                              â”‚
â”‚    {                                                â”‚
â”‚      title: "Hello!",                               â”‚
â”‚      body: "This is a notification"                 â”‚
â”‚    }                                                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Fetch all subscriptions from MongoDB             â”‚
â”‚    db.subscriptions.find()                          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. For each subscription:                           â”‚
â”‚    webpush.sendNotification(subscription, payload)  â”‚
â”‚                                                     â”‚
â”‚    If 410/404 error â†’ Remove from database          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Push notification sent to browser                â”‚
â”‚    Via FCM/APNS/etc (browser's push service)        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Service worker receives push event               â”‚
â”‚    self.addEventListener('push', ...)               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Show notification to user                        â”‚
â”‚    registration.showNotification(title, options)    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User   â”‚
â”‚   sees   â”‚
â”‚  notify  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Click Notification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚
â”‚  clicks  â”‚
â”‚  notify  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Service worker receives click event              â”‚
â”‚    self.addEventListener('notificationclick', ...)  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Close notification                               â”‚
â”‚    event.notification.close()                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Check if app window is already open              â”‚
â”‚    clients.matchAll({ type: 'window' })             â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ Yes â”€â”€â–¶ Focus existing window
     â”‚
     â””â”€â”€â”€ No  â”€â”€â–¶ Open new window
                  clients.openWindow('/')
```

---

## ğŸ—‚ï¸ File Structure

```
push-notifications-fresh/
â”‚
â”œâ”€â”€ pages/                          # Frontend & API
â”‚   â”œâ”€â”€ index.tsx                   # UI with subscribe button
â”‚   â”œâ”€â”€ _app.tsx                    # Service worker registration
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ push/                   # Push notification APIs
â”‚           â”œâ”€â”€ vapid-public-key.ts # Get VAPID key
â”‚           â”œâ”€â”€ subscribe.ts        # Save subscription
â”‚           â”œâ”€â”€ unsubscribe.ts      # Remove subscription
â”‚           â”œâ”€â”€ send.ts             # Send notifications
â”‚           â””â”€â”€ list-subscriptions.ts # List all
â”‚
â”œâ”€â”€ lib/                            # Business logic
â”‚   â”œâ”€â”€ mongodb.ts                  # DB connection
â”‚   â””â”€â”€ vapid.ts                    # VAPID config
â”‚
â”œâ”€â”€ models/                         # Data models
â”‚   â””â”€â”€ Subscription.ts             # Subscription schema
â”‚
â”œâ”€â”€ public/                         # Static files
â”‚   â”œâ”€â”€ sw.js                       # Service worker
â”‚   â”œâ”€â”€ manifest.json               # PWA manifest
â”‚   â””â”€â”€ icon-*.png                  # App icons
â”‚
â”œâ”€â”€ scripts/                        # Utility scripts
â”‚   â””â”€â”€ generate-vapid-keys.js      # Generate keys
â”‚
â””â”€â”€ types/                          # TypeScript types
    â””â”€â”€ mongoose.d.ts               # Global types
```

---

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY LAYERS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: HTTPS
â”œâ”€ All communication encrypted
â””â”€ Required for push notifications

Layer 2: VAPID Authentication
â”œâ”€ Public key: Shared with clients
â”œâ”€ Private key: Kept secret on server
â””â”€ Proves server identity to push services

Layer 3: Push Service Validation
â”œâ”€ Browser validates push origin
â”œâ”€ Only authorized server can send
â””â”€ Prevents unauthorized notifications

Layer 4: User Permission
â”œâ”€ User must grant permission
â”œâ”€ Can revoke anytime
â””â”€ Per-origin permission

Layer 5: MongoDB Security
â”œâ”€ Connection string in .env.local
â”œâ”€ Not committed to git
â””â”€ IP whitelisting (production)

Layer 6: API Protection (Optional)
â”œâ”€ Add authentication middleware
â”œâ”€ Rate limiting
â””â”€ Input validation
```

---

## ğŸ“Š Component Interactions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPONENT DIAGRAM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Frontend (React)
â”œâ”€ index.tsx
â”‚  â”œâ”€ Checks push support
â”‚  â”œâ”€ Manages subscription state
â”‚  â”œâ”€ Handles user interactions
â”‚  â””â”€ Calls API endpoints
â”‚
Service Worker
â”œâ”€ sw.js
â”‚  â”œâ”€ Receives push events
â”‚  â”œâ”€ Shows notifications
â”‚  â”œâ”€ Handles clicks
â”‚  â””â”€ Manages app focus
â”‚
API Layer
â”œâ”€ vapid-public-key.ts  â†’ Returns public key
â”œâ”€ subscribe.ts         â†’ Saves to MongoDB
â”œâ”€ unsubscribe.ts       â†’ Removes from MongoDB
â”œâ”€ send.ts              â†’ Sends via web-push
â””â”€ list-subscriptions.ts â†’ Queries MongoDB
â”‚
Business Logic
â”œâ”€ mongodb.ts           â†’ Connection management
â”œâ”€ vapid.ts             â†’ VAPID configuration
â””â”€ web-push (npm)       â†’ Push protocol
â”‚
Data Layer
â””â”€ MongoDB
   â””â”€ subscriptions collection
      â”œâ”€ endpoint (unique index)
      â””â”€ timestamps (for cleanup)
```

---

## ğŸ”„ State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPLICATION STATE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Browser State
â”œâ”€ isSupported: boolean
â”‚  â””â”€ Checks: 'serviceWorker' in navigator && 'PushManager' in window
â”‚
â”œâ”€ permission: NotificationPermission
â”‚  â””â”€ Values: 'default' | 'granted' | 'denied'
â”‚
â”œâ”€ isSubscribed: boolean
â”‚  â””â”€ Checks: pushManager.getSubscription() !== null
â”‚
â””â”€ subscription: PushSubscription | null
   â””â”€ Contains: endpoint, keys (p256dh, auth)

Server State (MongoDB)
â”œâ”€ subscriptions: Array<Subscription>
â”‚  â””â”€ Each contains:
â”‚     â”œâ”€ endpoint (unique)
â”‚     â”œâ”€ keys (p256dh, auth)
â”‚     â”œâ”€ userAgent
â”‚     â””â”€ timestamps

Service Worker State
â”œâ”€ registration: ServiceWorkerRegistration
â””â”€ push events: Queued and processed
```

---

## ğŸ¯ Request/Response Flow

### Subscribe Request

```
Client                          Server                    MongoDB
  â”‚                               â”‚                         â”‚
  â”œâ”€ POST /api/push/subscribe â”€â”€â”€â–¶â”‚                         â”‚
  â”‚  {                            â”‚                         â”‚
  â”‚    endpoint: "...",           â”‚                         â”‚
  â”‚    keys: {...}                â”‚                         â”‚
  â”‚  }                            â”‚                         â”‚
  â”‚                               â”‚                         â”‚
  â”‚                               â”œâ”€ Validate data         â”‚
  â”‚                               â”‚                         â”‚
  â”‚                               â”œâ”€ Connect to DB â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                               â”‚                         â”‚
  â”‚                               â”‚â—€â”€ Connection OK â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                               â”‚                         â”‚
  â”‚                               â”œâ”€ Save subscription â”€â”€â”€â”€â–¶â”‚
  â”‚                               â”‚                         â”‚
  â”‚                               â”‚â—€â”€ Subscription saved â”€â”€â”€â”¤
  â”‚                               â”‚                         â”‚
  â”‚â—€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
  â”‚  {                            â”‚                         â”‚
  â”‚    success: true,             â”‚                         â”‚
  â”‚    subscriptionId: "..."      â”‚                         â”‚
  â”‚  }                            â”‚                         â”‚
  â”‚                               â”‚                         â”‚
```

### Send Notification Request

```
Client                          Server                    MongoDB
  â”‚                               â”‚                         â”‚
  â”œâ”€ POST /api/push/send â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                         â”‚
  â”‚  {                            â”‚                         â”‚
  â”‚    title: "Hello",            â”‚                         â”‚
  â”‚    body: "World"              â”‚                         â”‚
  â”‚  }                            â”‚                         â”‚
  â”‚                               â”‚                         â”‚
  â”‚                               â”œâ”€ Validate data         â”‚
  â”‚                               â”‚                         â”‚
  â”‚                               â”œâ”€ Fetch subscriptions â”€â”€â–¶â”‚
  â”‚                               â”‚                         â”‚
  â”‚                               â”‚â—€â”€ Return all subs â”€â”€â”€â”€â”€â”€â”¤
  â”‚                               â”‚                         â”‚
  â”‚                               â”œâ”€ For each subscription: â”‚
  â”‚                               â”‚   webpush.send(...)     â”‚
  â”‚                               â”‚                         â”‚
  â”‚                               â”œâ”€ If 410/404 error:     â”‚
  â”‚                               â”œâ”€ Remove subscription â”€â”€â”€â–¶â”‚
  â”‚                               â”‚                         â”‚
  â”‚â—€â”€ 200 OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
  â”‚  {                            â”‚                         â”‚
  â”‚    success: true,             â”‚                         â”‚
  â”‚    stats: {                   â”‚                         â”‚
  â”‚      total: 5,                â”‚                         â”‚
  â”‚      successful: 4,           â”‚                         â”‚
  â”‚      failed: 0,               â”‚                         â”‚
  â”‚      removed: 1               â”‚                         â”‚
  â”‚    }                          â”‚                         â”‚
  â”‚  }                            â”‚                         â”‚
  â”‚                               â”‚                         â”‚
```

---

## ğŸŒ Browser Push Service Flow

```
Your Server                 Push Service              User's Browser
    â”‚                           â”‚                           â”‚
    â”œâ”€ webpush.send() â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
    â”‚  (with VAPID signature)   â”‚                           â”‚
    â”‚                           â”‚                           â”‚
    â”‚                           â”œâ”€ Validate VAPID          â”‚
    â”‚                           â”‚                           â”‚
    â”‚                           â”œâ”€ Queue notification      â”‚
    â”‚                           â”‚                           â”‚
    â”‚â—€â”€ 201 Created â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
    â”‚                           â”‚                           â”‚
    â”‚                           â”œâ”€ Send to browser â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                           â”‚                           â”‚
    â”‚                           â”‚                           â”œâ”€ Trigger SW
    â”‚                           â”‚                           â”‚
    â”‚                           â”‚                           â”œâ”€ Show notify
    â”‚                           â”‚                           â”‚
```

**Push Services:**
- Chrome/Edge: Firebase Cloud Messaging (FCM)
- Firefox: Mozilla Push Service
- Safari: Apple Push Notification Service (APNS)

---

## ğŸ’¾ Database Operations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MONGODB OPERATIONS                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Create (Subscribe)
â””â”€ db.subscriptions.findOneAndUpdate(
     { endpoint },
     { $set: { endpoint, keys, userAgent } },
     { upsert: true }
   )

Read (List)
â””â”€ db.subscriptions.find().sort({ createdAt: -1 })

Update (Implicit in upsert)
â””â”€ Happens automatically during subscribe

Delete (Unsubscribe)
â””â”€ db.subscriptions.deleteOne({ endpoint })

Delete (Expired)
â””â”€ db.subscriptions.deleteOne({ endpoint })
   (Called when push returns 410/404)
```

---

## ğŸ”§ Configuration Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONFIGURATION                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Environment Variables (.env.local)
â”œâ”€ MONGODB_URI
â”‚  â””â”€ Used by: lib/mongodb.ts
â”‚
â”œâ”€ NEXT_PUBLIC_VAPID_PUBLIC_KEY
â”‚  â””â”€ Used by: Browser (public), lib/vapid.ts
â”‚
â”œâ”€ VAPID_PRIVATE_KEY
â”‚  â””â”€ Used by: lib/vapid.ts (server-only)
â”‚
â””â”€ VAPID_SUBJECT
   â””â”€ Used by: lib/vapid.ts

VAPID Configuration (lib/vapid.ts)
â””â”€ webpush.setVapidDetails(
     subject,
     publicKey,
     privateKey
   )

MongoDB Connection (lib/mongodb.ts)
â””â”€ mongoose.connect(MONGODB_URI)
   â””â”€ Cached globally for reuse

Subscription Model (models/Subscription.ts)
â””â”€ Defines schema and validation
```

---

## ğŸ“± Client-Side Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BROWSER COMPONENTS                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Main Thread (React App)
â”œâ”€ UI Rendering
â”œâ”€ User Interactions
â”œâ”€ API Calls
â””â”€ State Management

Service Worker Thread
â”œâ”€ Push Event Handling
â”œâ”€ Notification Display
â”œâ”€ Background Sync
â””â”€ Cache Management

Push Manager (Browser API)
â”œâ”€ Subscription Management
â”œâ”€ Push Service Communication
â””â”€ Endpoint Generation

Notification API (Browser API)
â”œâ”€ Permission Management
â”œâ”€ Notification Display
â””â”€ Action Handling
```

---

## ğŸ¯ Summary

This architecture provides:

âœ… **Scalability** - MongoDB can handle millions of subscriptions
âœ… **Reliability** - Auto-cleanup of expired subscriptions
âœ… **Security** - VAPID authentication, HTTPS required
âœ… **Flexibility** - Rich notification options
âœ… **Maintainability** - Clean separation of concerns
âœ… **Type Safety** - Full TypeScript support
âœ… **Performance** - Cached database connections
âœ… **User Experience** - Simple subscribe/unsubscribe flow

---

**For implementation details, see:**
- Setup: `QUICK_START.md`
- API: `API_EXAMPLES.md`
- Complete guide: `PUSH_NOTIFICATIONS.md`
